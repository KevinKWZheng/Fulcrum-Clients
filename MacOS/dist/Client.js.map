{"version":3,"file":"Client.js","sources":["../src/util.ts","../src/managers/user.ts","../src/managers/base/base.ts","../src/managers/conversations.ts","../src/managers/invoices.ts","../src/managers/assistants.ts","../src/processor.ts","../main.ts"],"sourcesContent":["import * as fsSync from \"fs\";\nimport { createHmac, createHash } from \"crypto\";\nimport { v4 as UUID } from \"uuid\";\nimport axios from \"axios\";\n\nexport class Logger {\n    protected cacheDir: string;\n    protected getLogFile(timestamp?: string) {\n        let time = new Date();\n        if (timestamp)\n            time = new Date(timestamp);\n        return `${this.cacheDir}/${time.getUTCFullYear()}-${time.getUTCMonth()}-${time.getUTCDate()}-${time.getUTCHours()}.log`;\n    }\n    constructor(module?: string) {\n        if (module) {\n            this.cacheDir = `logs/${module}`;\n        } else {\n            this.cacheDir = `logs/`;\n        } if (!fsSync.existsSync(this.cacheDir)) {\n            fsSync.mkdirSync(this.cacheDir, { recursive: true });\n        }\n    }\n    public log(msg: string) {\n        const now = new Date();\n        const output = `${now.toISOString()}::\\t${msg}\\n`;\n        fsSync.writeFileSync(this.getLogFile(), output, { encoding: `utf-8`, flag: `as` });\n    }\n}\n\nexport function sign(content: string, secretKey: string) {\n    const Hmac = createHmac(`sha512`, secretKey);\n    Hmac.update(content, `utf-8`);\n    return Hmac.digest().toString(`hex`).toLowerCase();\n}\n\nexport function verify(content: string, secretKey: string, signature: string) {\n    const unverified = sign(content, secretKey);\n    return unverified == signature;\n}\n\nexport function getUUID() {\n    return UUID();\n}\n\nexport function getHash(str: string) {\n    const hash = createHash(`sha512`);\n    hash.update(str);\n    return hash.digest().toString(`base64url`);\n}\n\nexport async function ping() {\n    const stamp1 = new Date();\n    const response = await axios.get(`http://api.fulcrum-ai.dev:11451/ping`);\n    if (response.status != 200) throw new Error(`Unable to connect to server`);\n    const stamp2 = new Date();\n    return { ip: response.data.ip, lag: stamp2.getTime() - stamp1.getTime() };\n}\n\nexport async function getAnnouncement() {\n    const response = await axios.get(`http://api.fulcrum-ai.dev:11451/announce`);\n    return response.data.msg as string;\n}\n\nexport function clearOutput() {\n    process.stdout.write(\n        process.platform === \"win32\" ? \"\\x1B[2J\\x1B[0f\" : \"\\x1B[2J\\x1B[3J\\x1B[H\"\n    );\n}","import { Logger, getHash, sign } from \"../util\";\nimport axios from \"axios\";\nconst fetcher = axios.create({\n    baseURL: `http://api.fulcrum-ai.dev:11451/`,\n    headers: { \"Content-Type\": `application/json` },\n    validateStatus: (status) => {\n        return status <= 500;\n    }\n});\n\nexport class UserManager {\n    protected logger: Logger;\n    protected username: string;\n    protected secretKey: string;\n    protected assistantIds: string[];\n    protected conversationIds: string[];\n    protected invoiceIds: string[];\n    protected currAssistant: string;\n    protected currConversation: string;\n    protected balance: number;\n\n    protected credentials: {\n        username: string;\n        secretKey: string;\n    };\n\n    constructor() {\n        this.conversationIds = [];\n        this.assistantIds = [];\n        this.conversationIds = [];\n        this.invoiceIds = [];\n        this.currAssistant = ``;\n        this.currConversation = ``;\n        this.balance = 0;\n        this.username = ``;\n        this.secretKey = ``;\n        this.credentials = {\n            username: ``,\n            secretKey: ``\n        };\n        this.logger = new Logger(`User`);\n    }\n\n    public getUsername() {\n        return this.username;\n    }\n\n    public getBalance() {\n        return this.balance;\n    }\n\n    public getCurrConversation() {\n        return this.currConversation;\n    }\n\n    public getCurrAssistant() {\n        return this.currAssistant;\n    }\n\n    public async login(username: string, password: string) {\n        const secretKey = getHash(password);\n        const body = {\n            username: username\n        };\n        const response = await fetcher.post(`/login`, JSON.stringify(body), {\n            headers: {\n                \"signature\": sign(JSON.stringify(body), secretKey)\n            }\n        });\n        const result = response.data as ServerResponse;\n        let errMsg = ``;\n        if (!result.status) {\n            errMsg = `Log in failed: ${result.msg}`;\n            this.logger.log(errMsg);\n        }\n        else {\n            this.secretKey = secretKey;\n            this.username = username;\n        }\n        return { status: result.status, errMsg: errMsg };\n    }\n\n    public setCurrConversation(conversationId: string) {\n        if (!conversationId.length) {\n            this.currConversation = ``;\n            return true;\n        }\n        if (!this.conversationIds.includes(conversationId))\n            return false;\n        this.currConversation = conversationId;\n        return true;\n\n    }\n\n    public setCurrAssistant(assistantId: string) {\n        if (!this.assistantIds.includes(assistantId))\n            return false;\n        this.currAssistant = assistantId;\n        return true;\n    }\n\n    public async sendMessage(message: string) {\n        const conversationId = this.currConversation ? this.currConversation : ``;\n        const reqBody = {\n            username: this.username,\n            message: message,\n            assistantId: this.currAssistant,\n            conversationId: conversationId\n        } as CliRequest.Body;\n        const response = await fetcher.post(`/message`, JSON.stringify(reqBody), {\n            headers: { signature: sign(JSON.stringify(reqBody), this.secretKey) }\n        });\n        const data: ServerResponse = response.data;\n        if (!response.status || !data.status) {\n            return {\n                status: false,\n                message: response.statusText + `\\t` + data.msg\n            };\n        }\n        else return {\n            status: true,\n            content: data.content as {\n                message: string;\n                conversationId: string;\n                conversation: Conversation;\n                assistantId: string;\n            }\n        };\n    }\n\n    public async register(username: string, password: string, email: string, token: string) {\n        const response = (await fetcher.post(`/register`, JSON.stringify({\n            username: username,\n            password: password,\n            email: email,\n            token: token\n        }))).data as ServerResponse;\n        let errMsg = ``;\n        if (!response.status) {\n            errMsg = `Registration failed: ${response.msg}`;\n            this.logger.log(errMsg);\n        }\n        else {\n            this.secretKey = getHash(password);\n            this.username = username;\n        }\n        return {\n            status: response.status,\n            errMsg: errMsg\n        };\n    }\n\n    public listAssistantIds() {\n        return this.assistantIds;\n    }\n\n    public listConversationIds() {\n        return this.conversationIds;\n    }\n\n    public listInvoiceIds() {\n        return this.invoiceIds;\n    }\n\n    public async sync() {\n        const user = {\n            balance: this.balance,\n            assistantIds: this.assistantIds,\n            conversationIds: this.conversationIds,\n            invoiceIds: this.invoiceIds\n        };\n        const body = {\n            username: this.username,\n            reqInfo: { hash: getHash(JSON.stringify(user)) }\n        } as CliRequest.Body;\n        const bodyStr = JSON.stringify(body);\n        const response = await fetcher.post(`/fetch`, bodyStr, {\n            headers: { signature: sign(bodyStr, this.secretKey) }\n        });\n        if (!response.status) {\n            this.logger.log(`Data sync failed (external access error): ${response.statusText}`);\n            return;\n        }\n        const data = response.data as ServerResponse;\n        if (!data.status) {\n            this.logger.log(`Data sync failed (server internal err): ${data.msg}`);\n        } else {\n            this.logger.log(`Data synced from server: \\n${JSON.stringify(data.content, null, 4)}`);\n            if (data.content.assistantIds)\n                this.assistantIds = data.content.assistantIds;\n            if (data.content.conversationIds)\n                this.conversationIds = data.content.conversationIds;\n            if (data.content.invoiceIds)\n                this.invoiceIds = data.content.invoiceIds;\n            if (data.content.balance)\n                this.balance = data.content.balance;\n        }\n        return data.status;\n    }\n\n    public isLoggedIn() {\n        return (this.username.length > 0) ? true : false;\n    }\n\n    public async recharge(token: string) {\n        const body = {\n            username: this.username,\n            operations: {\n                recharge: token\n            }\n        };\n        const bodyStr = JSON.stringify(body);\n        const response = await fetcher.post(`/operations`, bodyStr, {\n            headers: {\n                signature: sign(bodyStr, this.secretKey)\n            }\n        });\n        if (!response.status) {\n            this.logger.log(`Operation failed (external access error): ${response.statusText}`);\n            return { status: false, msg: `Operation failed (external access error): ${response.statusText}` };\n        }\n        const data = response.data as ServerResponse;\n        if (!data.status) {\n            this.logger.log(`Operation failed (server internal err): ${data.msg}`);\n            return { status: false, msg: `Operation failed (server internal err): ${data.msg}` };\n        } else {\n            return { status: true, msg: data.content.invoiceId };\n        }\n    }\n}","import * as fsSync from \"fs\";\nimport { Logger, getHash } from \"../../util\";\n\nexport class DataManager {\n    protected readonly cacheDir: string;\n    protected readonly credentials: {\n        username: string;\n        secretKey: string;\n    };\n    protected logger: Logger;\n    constructor(module: string, username?: string, password?: string) {\n        this.cacheDir = `.cache/${module}`;\n        this.credentials = {\n            username: username ? username : ``,\n            secretKey: password ? getHash(password) : ``,\n        }\n        if (!fsSync.existsSync(this.cacheDir))\n            fsSync.mkdirSync(this.cacheDir, { recursive: true });\n        this.logger = new Logger(module);\n    }\n\n    public setCredentials(username?: string, password?: string) {\n        this.credentials.username = username ? username : this.credentials.username;\n        this.credentials.secretKey = password ? getHash(password) : this.credentials.secretKey;\n    }\n}","import * as fsAsync from \"fs/promises\";\nimport axios from \"axios\";\nimport { sign } from \"../util\";\nimport { DataManager } from \"./base/base\";\nimport columnify from \"columnify\";\nconst fetcher = axios.create({\n    baseURL: `http://api.fulcrum-ai.dev:11451/`,\n    headers: { \"Content-Type\": `application/json` },\n    validateStatus: (status) => {\n        return status <= 500;\n    }\n});\n\nexport class ConversationManager extends DataManager {\n    constructor(username?: string, password?: string) {\n        super(`conversations`, username, password);\n    }\n\n    public async get(conversationId: string) {\n        await this.download([conversationId]);\n        const raw = await fsAsync.readFile(`${this.cacheDir}/${conversationId}.conv`, { encoding: `utf-8` });\n        return JSON.parse(raw) as Conversation;\n    }\n\n    public async download(conversationIds: string[]) {\n        const body = {\n            username: this.credentials.username,\n            reqInfo: {\n                conversationIds: conversationIds\n            }\n        }\n        const response = await fetcher.post(`/fetch`, JSON.stringify(body), {\n            headers: {\n                signature: sign(JSON.stringify(body), this.credentials.secretKey)\n            }\n        });\n        const resultIds: string[] = [];\n        if (response.status != 200) {\n            this.logger.log(`Download request failed (external): ${response.statusText} ${response.status}`);\n            return resultIds;\n        }\n        const data = response.data as ServerResponse;\n        if (!data.status) {\n            this.logger.log(`Download request failed (internal): ${data.msg}`);\n            return resultIds;\n        }\n        const conversations: Conversation[] = data.content.conversations;\n        for (const i in conversations) {\n            const conversation = conversations[i];\n            resultIds.push(conversation.id);\n            await fsAsync.writeFile(`${this.cacheDir}/${conversation.id}.conv`,\n                JSON.stringify(conversation, null, 4), { encoding: `utf-8` });\n        }\n        this.logger.log(`Downloaded conversation files from server: \\n\\t${resultIds.join(`\\n\\t`)}`);\n        return resultIds;\n    }\n\n    public async listInfo(conversationIds: string[]) {\n        const conversations: Conversation[] = [];\n        for (const i in conversationIds) {\n            const conversation = await this.get(conversationIds[i]);\n            conversations.push(conversation);\n        }\n        const str = columnify(conversations, {\n            columns: [`title`, `id`],\n            columnSplitter: `|`\n        });\n        return str;\n    }\n}","import * as fsSync from \"fs\";\nimport * as fsAsync from \"fs/promises\";\nimport columnify from \"columnify\";\nimport axios from \"axios\";\nimport { sign } from \"../util\";\nimport { DataManager } from \"./base/base\";\nconst fetcher = axios.create({\n    baseURL: `http://api.fulcrum-ai.dev:11451/`,\n    headers: { \"Content-Type\": `application/json` },\n    validateStatus: (status) => {\n        return status <= 500;\n    }\n});\n\nexport class InvoiceManager extends DataManager {\n    constructor(username?: string, password?: string) {\n        super(`invoices`, username, password);\n    }\n    public async get(invoiceId: string) {\n        if (!fsSync.existsSync(`${this.cacheDir}/${invoiceId}.invoice`))\n            await this.download([invoiceId]);\n        const raw = await fsAsync.readFile(`${this.cacheDir}/${invoiceId}.invoice`, `utf-8`);\n        return JSON.parse(raw) as Invoice;\n    }\n\n    public async download(invoiceIds: string[]) {\n        const body = {\n            username: this.credentials.username,\n            reqInfo: {\n                invoiceIds: invoiceIds\n            }\n        };\n        const response = await fetcher.post(`/fetch`, JSON.stringify(body), {\n            headers: {\n                signature: sign(JSON.stringify(body), this.credentials.secretKey),\n            }\n        });\n        const resultIds: string[] = [];\n        if (response.status != 200) {\n            this.logger.log(`Download request failed (external): ${response.statusText} ${response.status}`);\n            return resultIds;\n        }\n        const data = response.data as ServerResponse;\n        if (!data.status) {\n            this.logger.log(`Download request failed (internal): ${data.msg}`);\n            return resultIds;\n        }\n        const invoices = data.content.invoices as Invoice[];\n        for (const i in invoices) {\n            resultIds.push(invoices[i].id);\n            await fsAsync.writeFile(`${this.cacheDir}/${invoices[i].id}.invoice`, JSON.stringify(invoices[i], null, 4), `utf-8`);\n        }\n        this.logger.log(`Downloaded invoice files from server: \\n\\t${resultIds.join(`\\n\\t`)}`);\n        return resultIds;\n    }\n\n    public async export(invoiceIds: string[], saveToFile: boolean) {\n        await this.download(invoiceIds);\n        const invoices: Invoice[] = [];\n        for (const i in invoiceIds) {\n            const raw = await fsAsync.readFile(`${this.cacheDir}/${invoiceIds[i]}.invoice`, `utf-8`);\n            const invoice = JSON.parse(raw);\n            invoices.push(invoice);\n        }\n        const exportStr = columnify(invoices, {\n            columns: [`timestamp`, `id`, `description`, `inputTokens`, `inputPrice`, `outputTokens`, `outputPrice`, `total`],\n            columnSplitter: (saveToFile) ? `,` : `|`,\n        });\n        return exportStr;\n    }\n}","import * as fsSync from \"fs\";\nimport * as fsAsync from \"fs/promises\";\nimport axios from \"axios\";\nimport { sign } from \"../util\";\nimport { DataManager } from \"./base/base\";\nimport columnify from \"columnify\";\nconst fetcher = axios.create({\n    baseURL: `http://api.fulcrum-ai.dev:11451/`,\n    headers: { \"Content-Type\": `application/json` },\n    validateStatus: (status) => {\n        return status <= 500;\n    }\n});\n\nexport class AssistantManager extends DataManager {\n    protected Names: Map<string, string>;\n    protected Ids: Map<string, string>;\n    constructor(username?: string, password?: string) {\n        super(`assistants`, username, password);\n        this.Names = new Map();\n        this.Ids = new Map();\n    }\n\n    public async get(assistantId: string) {\n        if (!fsSync.existsSync(`${this.cacheDir}/${assistantId}.asst`))\n            await this.download([assistantId]);\n        const raw = await fsAsync.readFile(`${this.cacheDir}/${assistantId}.asst`, { encoding: `utf-8` });\n        return JSON.parse(raw) as AssistantInfo;\n    }\n\n    public getName(assistantId: string) {\n        return this.Names.get(assistantId);\n    }\n\n    public getId(name: string) {\n        name = name.toLowerCase();\n        return this.Ids.get(name);\n    }\n\n    public async download(assistantIds: string[]) {\n        const body = {\n            username: this.credentials.username,\n            reqInfo: {\n                assistantIds: assistantIds\n            }\n        };\n        const response = await fetcher.post(`/fetch`, JSON.stringify(body), {\n            headers: {\n                signature: sign(JSON.stringify(body), this.credentials.secretKey)\n            }\n        });\n        const resultIds: string[] = [];\n        if (response.status != 200) {\n            this.logger.log(`Download request failed (external): ${response.statusText} ${response.status}`);\n            return resultIds;\n        }\n        const data = response.data as ServerResponse;\n        if (!data.status) {\n            this.logger.log(`Download request failed (internal): ${data.msg}`);\n            return resultIds;\n        }\n        const assistants: AssistantInfo[] = data.content.assistants;\n        for (const i in assistants) {\n            const assistant = assistants[i];\n            resultIds.push(assistant.id);\n            this.Names.set(assistant.id, assistant.name);\n            this.Ids.set(assistant.name.toLowerCase(), assistant.id);\n            await fsAsync.writeFile(`${this.cacheDir}/${assistant.id}.asst`, JSON.stringify(assistant, null, 4), `utf-8`);\n        }\n        this.logger.log(`Downloaded assistant files from server: \\n\\t${resultIds.join(`\\n\\t`)}`);\n        return resultIds;\n    }\n\n    public async listInfo(assistantIds: string[]) {\n        const assistants: AssistantInfo[] = [];\n        for (const i in assistantIds) {\n            const assistant = await this.get(assistantIds[i]);\n            assistants.push(assistant);\n        }\n        const str = columnify(assistants, {\n            columns: [`name`, `id`],\n            columnSplitter: `|`\n        });\n        return str;\n    }\n}","import { UserManager } from \"./managers/user\";\nimport { ping, clearOutput, getAnnouncement } from \"./util\";\nimport * as fsSync from \"fs\";\nimport * as fsAsync from \"fs/promises\";\nimport { ConversationManager } from \"./managers/conversations\";\nimport { InvoiceManager } from \"./managers/invoices\";\nimport { AssistantManager } from \"./managers/assistants\";\nimport t from \"terminal-kit\";\nimport delay from \"delay\";\nconst terminal = t.terminal;\n\nconst User = new UserManager();\nconst Assistants = new AssistantManager();\nconst Conversations = new ConversationManager();\nconst Invoices = new InvoiceManager();\nconst version = `1.1.0`;\n\nlet busy = false;\nlet bound = false;\n\nasync function printMessage(role: string, message: string, opts?: {\n    slowTyping?: boolean;\n    timestamp?: string;\n}) {\n    let now = new Date();\n    if (opts && opts.timestamp)\n        now = new Date(opts.timestamp);\n    const dateStr = `${now.getFullYear()}.${now.getMonth() + 1}.${now.getDate()}`;\n    const timestamp = `${now.toTimeString().substring(0, 8)}`;\n    terminal(dateStr + ` `).green(timestamp + ` `).cyan(role).defaultColor(`> : `);\n    if (opts && opts.slowTyping) {\n        for (let i = 0; i < message.length; i++) {\n            process.stdout.write(message.charAt(i));\n            await delay(10);\n        }\n    }\n    else\n        process.stdout.write(message);\n    terminal(`\\n\\n`);\n}\n\nexport async function setup() {\n    const result = await ping();\n    terminal.green.bold(`Server connection established from IP ${result.ip}, ping: ${result.lag} ms\\n`);\n    terminal.bold(`Process started. \\n`);\n    keyBind();\n    let username = ``;\n\n    while (!User.isLoggedIn()) {\n        terminal.saveCursor().eraseDisplayBelow();\n        const option = await terminal.singleColumnMenu([`Login`, `Register`]).promise;\n        terminal(`\\n`);\n\n        if (option.selectedIndex == 0) {\n            terminal(`Log in process initiated.\\n`);\n            terminal(`\\nUsername: `);\n            username = await terminal.inputField().promise as string;\n            terminal(`\\nPassword: `);\n            const password = await terminal.inputField({\n                echoChar: `*`\n            }).promise as string;\n\n            const result = await User.login(username, password);\n            if (!result.status) {\n                terminal.red(`Log in failed: ${result.errMsg}`);\n            } else {\n                Assistants.setCredentials(username, password);\n                Conversations.setCredentials(username, password);\n                Invoices.setCredentials(username, password);\n                break;\n            }\n        } else {\n            terminal.bold(`Registration process initiated.\\n`);\n            terminal(`\\nUsername: `);\n            username = await terminal.inputField().promise as string;\n            terminal(`\\nEmail: `);\n            const email = await terminal.inputField().promise as string;\n            terminal(`\\nPassword: `);\n            const password = await terminal.inputField({ echoChar: `*` }).promise as string;\n            terminal(`\\nInvitation Code: `);\n            const token = await terminal.inputField().promise as string;\n\n            const result = await User.register(username, password, email, token);\n            if (!result.status) {\n                terminal.red(`Registration failed: ${result.errMsg}`);\n            } else {\n                Assistants.setCredentials(username, password);\n                Conversations.setCredentials(username, password);\n                Invoices.setCredentials(username, password);\n                break;\n            }\n        }\n        await delay(2000);\n        terminal.restoreCursor().eraseDisplayBelow();\n    }\n    clearOutput();\n    await User.sync();\n    await Assistants.download(User.listAssistantIds());\n    await Conversations.download(User.listConversationIds());\n    await Invoices.download(User.listInvoiceIds());\n    if (!fsSync.existsSync(`downloads`))\n        fsSync.mkdirSync(`downloads`);\n    User.setCurrAssistant(Assistants.getId(`GPT-4`) as string);\n    terminal.green.bold(`Log in success!\\n`);\n    terminal(`Welcome to Fulcrum AI\\nType message directly to chat with AI Assistants\\n`);\n    terminal(`Press CTRL_L to see Menu, Settings, and current announcement\\n\\n`);\n    terminal.bold(`***Latest announcement from server***\\n${await getAnnouncement()}\\n\\n`);\n    //terminal.saveCursor().bold(`>>`);\n    onMessage();\n}\n\nfunction onMessage() {\n    if (bound || busy) return;\n    bound = true;\n    terminal.saveCursor();\n    terminal.bold(`>>`);\n    terminal.inputField({}, async (err, input) => {\n        if (busy || !input) {\n            //terminal.restoreCursor().eraseLine().eraseDisplayBelow();\n            bound = false;\n            onMessage();\n            return;\n        }\n        if (err) {\n            terminal.red.bold(`\\nAn error occurred: ${err}\\n`).saveCursor();\n            await delay(3000);\n            bound = false;\n            onMessage();\n            return;\n        }\n        terminal.restoreCursor().eraseLine().eraseDisplayBelow();\n\n        busy = true;\n        await printMessage(User.getUsername(), input);\n        const animate = (await terminal.spinner(`unboxing-color`));\n        const response = await User.sendMessage(input);\n        if (response.status && response.content) {\n            animate.animate(false);\n            terminal.eraseLine().move(-1, 0);\n            await printMessage(Assistants.getName(response.content.assistantId) as string, response.content.message, {\n                slowTyping: true\n            });\n            await User.sync();\n            User.setCurrConversation(response.content.conversationId);\n        } else {\n            terminal.red.bold(`\\nAn error occurred: ${err}\\n`).saveCursor();\n            bound = false;\n            onMessage();\n            return;\n        }\n        busy = false;\n        terminal(`\\n`);\n        bound = false;\n        onMessage();\n    });\n}\n\nfunction keyBind() {\n    terminal.on(`key`, (name: string) => {\n        if (!User.isLoggedIn()) {\n            if (name == `CTRL_Q`) {\n                terminal.red(`Exiting program...`);\n                process.exit(0);\n            }\n        }\n        if (User.isLoggedIn()) {\n            if (name == `CTRL_L`)\n                onMenu();\n        }\n    })\n}\n\nasync function onMenu() {\n    busy = true;\n    clearOutput();\n    terminal.bold(`**Current Announcement**\\n`);\n    terminal(await getAnnouncement());\n    terminal(`\\nPress ESC at any time to exit menu`);\n    terminal.singleLineMenu([`Status`, `Settings`, `Account`, `Clear Screen`, `Version`, `Exit`],\n        {\n            style: terminal.inverse,\n            selectedStyle: terminal.defaultColor,\n            cancelable: true\n        },\n        async (err, input) => {\n            if (err) {\n                terminal.red(`An error occurred turning on the menu`);\n                return;\n            }\n            terminal(`\\n`);\n            await User.sync();\n            if (input)\n                switch (input.selectedIndex) {\n                    case 0:\n                        terminal(`Current status: \\n`);\n                        terminal(`Account balance: ${User.getBalance()}\\n`);\n                        terminal(`Assistant: ${Assistants.getName(User.getCurrAssistant())}\\n`);\n                        const conversationId = User.getCurrConversation();\n                        if (!conversationId.length)\n                            terminal(`New conversation\\n`);\n                        else {\n                            const conversation = await Conversations.get(conversationId);\n                            terminal(`Conversation: \\nTitle: ${conversation.title}\\tId: ${conversation.id}\\n`);\n                        }\n                        break;\n                    case 1:\n                        clearOutput();\n                        const selected1 = await terminal.singleRowMenu([`Assistants`, `Conversations`], { cancelable: true }).promise;\n                        if (selected1.canceled) {\n                            terminal.red.bold(`\\nAction canceled\\n`);\n                            break;\n                        }\n                        terminal(`\\n`);\n                        if (selected1.selectedIndex == 0) {\n                            clearOutput();\n                            await Assistants.download(User.listAssistantIds());\n                            const assistantIds = User.listAssistantIds();\n                            const assistants: AssistantInfo[] = [];\n                            const names: string[] = [];\n                            for (const i in assistantIds) {\n                                const assistant = await Assistants.get(assistantIds[i]);\n                                assistants.push(assistant);\n                                names.push(assistant.name);\n                            }\n                            terminal(`Available Assistants: \\n`);\n                            const sA = await terminal.singleColumnMenu(names, { cancelable: true }).promise;\n                            if (sA.canceled) {\n                                terminal.red.bold(`\\nAction canceled\\n`);\n                                break;\n                            }\n                            User.setCurrAssistant(assistants[sA.selectedIndex].id);\n                            terminal.bold(`\\nCurrent assistant: ${sA.selectedText}\\n`);\n                        } else {\n                            clearOutput();\n                            await Conversations.download(User.listConversationIds());\n                            const conversationIds = User.listConversationIds();\n                            const conversations: Conversation[] = [];\n                            const list: string[] = [];\n                            for (const i in conversationIds) {\n                                const conversation = await Conversations.get(conversationIds[i]);\n                                conversations.push(conversation);\n                                list.push(conversation.title);\n                            }\n                            list.push(`New conversation`);\n                            const sC = await terminal.singleColumnMenu(list, { cancelable: true }).promise;\n                            if (sC.canceled) {\n                                terminal.red.bold(`\\nAction canceled\\n`);\n                                break;\n                            }\n                            if (sC.selectedIndex < conversations.length)\n                                User.setCurrConversation(conversations[sC.selectedIndex].id);\n                            else\n                                User.setCurrConversation(``);\n                            terminal.bold(`\\nCurrent conversation: ${sC.selectedText}\\n`);\n                        }\n                        break;\n                    case 2:\n                        clearOutput\n                        terminal(`Current balance: ${User.getBalance()}`);\n                        const selected2 = await terminal.singleColumnMenu([`Account Summary`, `Recharge/Top Up`], { cancelable: true }).promise;\n                        if (selected2.canceled) {\n                            terminal.red.bold(`\\nAction canceled\\n`);\n                            break;\n                        }\n                        terminal(`\\n`);\n                        if (selected2.selectedIndex == 0) {\n                            const invoiceIds = User.listInvoiceIds();\n                            await Invoices.download(invoiceIds);\n                            const exports = await Invoices.export(invoiceIds, true);\n                            await fsAsync.writeFile(`downloads/Account Summary.csv`, exports, `utf-8`);\n                            terminal(`Account summary downloaded to \"downloads\" folder\\n`);\n                            const invoices: Invoice[] = [];\n                            const desc: string[] = [];\n                            for (const i in invoiceIds) {\n                                const invoice = await Invoices.get(invoiceIds[i]);\n                                invoices.push(invoice);\n                                desc.push(invoice.timestamp + `\\n` + invoice.description);\n                            }\n                            const sI = await terminal.singleColumnMenu(desc, { cancelable: true }).promise;\n                            if (sI.canceled) {\n                                terminal.red.bold(`\\nAction canceled\\n`);\n                                break;\n                            }\n                            terminal(`\\n`);\n                            const invoice = invoices[sI.selectedIndex];\n                            terminal(`ID: ${invoice.id}\\t Timestamp: ${invoice.timestamp}`);\n                            terminal(`Description: ${invoice.description}\\n`);\n                            if (invoice.inputCost) {\n                                terminal.table([\n                                    [`Input Tokens`, `Input Price (USD/1k tokens)`, `Input Total Costs`],\n                                    [(invoice.inputTokens as number).toString(), (invoice.inputPrice as number).toString(), (invoice.inputCost as number).toString()],\n                                    [`Output Tokens`, `Output Price (USD/1k tokens)`, `Output Total Costs`],\n                                    [(invoice.outputTokens as number).toString(), (invoice.outputPrice as number).toString(), (invoice.outputCost as number).toString()]\n                                ]);\n                                terminal(`\\n`);\n                            }\n                            terminal.bold(`Total: ${invoice.total}`);\n                        } else {\n                            terminal(`Input recharge code/token: `);\n                            const token = await terminal.inputField().promise;\n                            if (token && token.length) {\n                                const response = await User.recharge(token);\n                                if (!response.status) {\n                                    terminal.red.bold(`Operation unsuccessful, reason: ${response.msg}\\n`);\n                                    break;\n                                }\n                                terminal.green(`Operation successful! `);\n                                await User.sync();\n                                terminal.cyan(`Current balance: ${User.getBalance()}`);\n                            } else {\n                                terminal.red.bold(`Invalid token inputted: ${token}\\n`);\n                                break;\n                            }\n                        }\n                        break;\n                    case 3:\n                        clearOutput();\n                        break;\n                    case 4:\n                        terminal.bold(`\\nCurrent client version: ${version}\\nSee https://github.com/KevinKWZheng/Fulcrum-Clients for client side download & releases\\n`);\n                        break;\n                    case 5:\n                        const confirmation = await terminal.red(`\\nAre you sure to exit? [Y/N]\\n`).yesOrNo({\n                            yes: [`y`, `Y`, `ENTER`],\n                            no: [`n`, `N`]\n                        }).promise;\n                        if (confirmation) {\n                            terminal(`\\nExiting program...\\n`);\n                            terminal.processExit(0);\n                            await delay(2000);\n                        } else\n                            terminal.red.bold(`\\nOperation canceled`);\n                        break;\n                    default:\n                        break;\n                }\n            terminal.inverse(`\\n\\nPress any key to exit`);\n            terminal.once(`key`, async () => {\n                clearOutput();\n                terminal.moveTo(1, 1);\n                const conversationId = User.getCurrConversation();\n                if (conversationId && conversationId.length) {\n                    await Conversations.download([conversationId]);\n                    const conversation = await Conversations.get(conversationId);\n                    for (const i in conversation.messages) {\n                        const msg = conversation.messages[i];\n                        await printMessage(msg.username, msg.content, {\n                            timestamp: msg.timestamp\n                        });\n                    }\n                }\n                //terminal.saveCursor().bold(`>>`);\n                busy = bound = false;\n                terminal(`\\n`).saveCursor();\n                onMessage();\n            });\n        });\n}","import { setup } from \"./src/processor\";\n\nfunction init() {\n    return new Promise<void>(resolve => {\n        setup()\n            .then(() => resolve());\n    });\n}\n\ninit().then(() => {\n});\n"],"names":["Logger","cacheDir","getLogFile","timestamp","time","Date","this","getUTCFullYear","getUTCMonth","getUTCDate","getUTCHours","constructor","module","fsSync","existsSync","mkdirSync","recursive","log","msg","output","toISOString","writeFileSync","encoding","flag","sign","content","secretKey","Hmac","createHmac","update","digest","toString","toLowerCase","getHash","str","hash","createHash","async","getAnnouncement","axios","get","data","clearOutput","process","stdout","write","platform","fetcher","create","baseURL","headers","validateStatus","status","DataManager","credentials","logger","username","password","setCredentials","terminal","t","User","assistantIds","conversationIds","invoiceIds","currAssistant","currConversation","balance","getUsername","getBalance","getCurrConversation","getCurrAssistant","login","body","result","post","JSON","stringify","signature","errMsg","setCurrConversation","conversationId","length","includes","setCurrAssistant","assistantId","sendMessage","message","reqBody","response","statusText","register","email","token","listAssistantIds","listConversationIds","listInvoiceIds","sync","user","reqInfo","bodyStr","isLoggedIn","recharge","operations","invoiceId","Assistants","Names","Ids","super","Map","download","raw","fsAsync","readFile","parse","getName","getId","name","resultIds","assistants","i","assistant","push","id","set","writeFile","join","listInfo","columnify","columns","columnSplitter","Conversations","conversations","conversation","Invoices","invoices","saveToFile","invoice","version","busy","bound","printMessage","role","opts","now","dateStr","getFullYear","getMonth","getDate","toTimeString","substring","green","cyan","defaultColor","slowTyping","charAt","delay","setup","stamp1","Error","stamp2","ip","lag","getTime","ping","bold","on","red","exit","singleLineMenu","style","inverse","selectedStyle","cancelable","err","input","selectedIndex","title","selected1","singleRowMenu","promise","canceled","names","sA","singleColumnMenu","selectedText","list","sC","selected2","exports","export","desc","description","sI","inputCost","table","inputTokens","inputPrice","outputTokens","outputPrice","outputCost","total","inputField","yesOrNo","yes","no","processExit","once","moveTo","messages","saveCursor","onMessage","onMenu","eraseDisplayBelow","option","echoChar","restoreCursor","eraseLine","animate","spinner","move","Promise","resolve","then"],"mappings":"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"}